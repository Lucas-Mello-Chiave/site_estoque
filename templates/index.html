<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Chiave - Sistema de Controle de Produtos</title>
    <style>
        .logo-img {
    height: 50px;  /* ajusta como quiser */
    object-fit: contain;
}

        .btn-obs {
        background: transparent;
        border: none;
        cursor: pointer;
        font-size: 16px;
}
        /* Reset e base */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        html, body { height: 100%; }

        /* Fundo geral (solicitado) */
        body {
            background-color: #5E5E5E; /* cor pedida */
            color: #e9eef3;
            line-height: 1.6;
        }

        .container { max-width: 1200px; margin: 30px auto; padding: 20px; }

        header {
            background: linear-gradient(135deg, #46494d, #3B3B3B );
            color: white;
            padding: 18px 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
            border-bottom: 4px solid #C65911;
        }

        .header-content { display: flex; justify-content: space-between; align-items: center; max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        .logo h1 { font-weight: 700; font-size: 22px; letter-spacing: 0.6px; }

        /* Cards e containers: leve transpar√™ncia para contraste com o fundo escuro */
        .filters-container {
            padding: 18px;
            background-color: rgba(255,255,255,0.03);
            border-radius: 10px;
            margin-top: 20px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.35);
            border: 1px solid rgba(255,255,255,0.03);
        }

        .table-container {
            background: rgba(255,255,255,0.02);
            border-radius: 10px;
            overflow-x: auto;
            box-shadow: 0 6px 18px rgba(0,0,0,0.35);
            margin-top: 20px;
            border: 1px solid rgba(255,255,255,0.03);
        }

        /* Inputs */
        .search-wrapper { margin-bottom: 14px; }
        #searchInput {
            width: 100%;
            padding: 12px 15px;
            border-radius: 22px;
            border: 1px solid rgba(255,255,255,0.06);
            background: #444;
            color: #fff;
            font-size: 15px;
            transition: box-shadow .18s ease, border-color .18s ease;
        }
        #searchInput::placeholder { color: rgba(255,255,255,0.55); }
        #searchInput:focus { outline: none; border-color: rgba(198,89,17,0.95); box-shadow: 0 0 12px rgba(198,89,17,0.18); }

        .filter-group { margin-bottom: 12px; }
        .filter-group h3 { font-size: 16px; color: #f1f1f1; margin-bottom: 10px; }

        /* Bot√µes de filtro (ajustados para dark) */
        .filter-buttons button {
            background-color: #3B3B3B;
            border: 1px solid rgba(255,255,255,0.03);
            color: #e9eef3;
            padding: 7px 14px;
            margin: 6px 6px 6px 0;
            border-radius: 18px;
            cursor: pointer;
            font-weight: 600;
            transition: transform .12s ease, background .12s ease;
        }
        .filter-buttons button:hover { transform: translateY(-2px); background-color: #4a4a4a; }
        .filter-buttons button.active { background-color: #C65911; color: white; box-shadow: 0 4px 14px rgba(198,89,17,0.28); }

        /* Tabela */
        table { width: 100%; border-collapse: collapse; min-width: 720px; }
        thead { background: linear-gradient(90deg,#3b3b3b,#2f2f2f); color: #fff; }
        th, td { padding: 14px 18px; text-align: left; font-size: 14px; }
        thead th { position: sticky; top: 0; z-index: 2; }
        tbody tr { border-bottom: 1px solid rgba(255,255,255,0.03); }
        tbody tr:hover { background-color: rgba(255,255,255,0.02); }

        .stock-low { color: #ff9b8b; font-weight: 700; }

        footer { text-align: center; padding: 16px; color: #d1d1d1; margin-top: 20px; }

        /* Overlay e modais (ajuste de contraste) */
        .overlay {
            position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; z-index: 9999;
            background: rgba(0,0,0,0.6);
            visibility: hidden; opacity: 0; transition: opacity .18s ease, visibility 0s .18s;
        }
        .overlay.visible { visibility: visible; opacity: 1; transition: opacity .18s ease; }

        .modal {
            width: 360px; background: #2c2c2c; color: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 12px 30px rgba(0,0,0,0.6);
        }
        .modal.modal-large { width: 90%; max-width: 900px; }
        .modal h2 { margin-bottom: 12px; font-size: 18px; color: #fff; }
        .modal-row { margin-bottom: 12px; }
        .modal-row label { display: block; font-size: 13px; color: #dfe6ea; margin-bottom: 6px; }
        .modal-row input, .modal-row textarea {
            width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.05);
            background: #333; color: #fff; font-size: 14px;
        }
        .modal-row textarea { min-height: 220px; resize: vertical; font-family: 'Courier New', Courier, monospace; }
        .modal-actions { display: flex; justify-content: flex-end; margin-top: 10px; gap: 10px; }
        .modal-feedback { color: #ff6b6b; min-height: 18px; margin-top: 6px; font-size: 13px; }
        .modal-feedback.success { color: #2ecc71; }

        /* Bot√µes principais */
        .btn {
            background: linear-gradient(135deg, #C65911 0%, #a6440e 100%);
            border: none; color: white; padding: 9px 14px; border-radius: 8px; cursor: pointer; font-weight: 700;
            transition: transform .12s ease, box-shadow .12s ease, opacity .12s ease;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 22px rgba(198,89,17,0.22); }
        .btn:disabled { background: #6f6f6f; cursor: not-allowed; opacity: 0.9; }
        .btn.btn-secondary { background-color: #3B3B3B; color: #e9eef3; border: 1px solid rgba(255,255,255,0.03); }
        .btn.btn-secondary:hover { background-color: #4a4a4a; }

        /* Settings gear */
        .settings-container { position: fixed; top: 18px; right: 18px; z-index: 10000; }
        #settings-gear { width: 50px; height: 50px; background: #3B3B3B; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 6px 18px rgba(0,0,0,0.45); }
        #settings-gear svg { width: 26px; height: 26px; fill: white; transition: transform .25s ease; }
        #settings-gear:hover svg { transform: rotate(90deg); }
        #settings-menu { position: absolute; top: 60px; right: 0; background: #2c2c2c; border-radius: 8px; box-shadow: 0 8px 30px rgba(0,0,0,0.5); overflow: hidden; display: none; flex-direction: column; width: 220px; }
        #settings-menu.visible { display: flex; }
        #settings-menu button { background: none; border: none; padding: 12px 14px; text-align: left; width: 100%; cursor: pointer; color: #e9eef3; border-bottom: 1px solid rgba(255,255,255,0.03); }
        #settings-menu button:last-child { border-bottom: none; }
        #settings-menu button:hover { background: rgba(255,255,255,0.02); }

        /* Ajuste responsivo simples */
        @media (max-width: 760px) {
            .modal { width: 92%; }
            table { min-width: 600px; }
            .logo h1 { font-size: 18px; }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <div class="logo">
                <img src="{{ url_for('static', filename='assets/logo.png') }}" 
                 alt="Chiave - Controle de Estoque" 
                 class="logo-img">
            </div>
        </div>
    </header>

    <div class="container">
        <div class="filters-container">
            <div class="search-wrapper">
                <input type="text" id="searchInput" placeholder="Pesquisar por nome, marca ou vertical...">
            </div>

            <div class="filter-group">
                <h3>Filtrar por Marca:</h3>
                <div class="filter-buttons" id="brandFilters"></div>
            </div>

            <div class="filter-group">
                <h3>Filtrar por Vertical:</h3>
                <div class="filter-buttons" id="verticalFilters"></div>
            </div>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>NOME</th>
                        <th>ID</th>
                        <th>MARCA</th>
                        <th>VERTICAL</th>
                        <th id="stockHeader">ESTOQUE <span id="stockArrow">‚Üï</span></th>
                        <th>UNID.VEND</th>
                        <th>OBS</th>
                    </tr>
                </thead>
                <tbody id="productTableBody"></tbody>
            </table>
        </div>
    </div>

    <footer>
        <p>Chiave &copy; 2025 - Sistema de Controle de Produtos</p>
    </footer>

    <div class="settings-container">
        <div id="settings-gear">
            <svg viewBox="0 0 24 24"><path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61-.25-1.17-.59-1.69-.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24-.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.09.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"/></svg>
        </div>
        <div id="settings-menu">
            <button id="management-btn">Gerenciamento</button>
            <button id="edit-products-btn">Editar Produtos</button>
            <button id="connections-btn">Conex√£o</button>
        </div>
    </div>

    <!-- Overlays e modais (mantive a estrutura e o comportamento original) -->
    <div id="loginOverlay" class="overlay visible">
        <div class="modal">
            <h2>Entre com seu e-mail</h2>
            <div class="modal-row">
                <label for="loginEmail">E-mail</label>
                <input id="loginEmail" type="email" placeholder="seu@exemplo.com" />
            </div>
            <div class="modal-row">
                <label for="loginPassword">Senha</label>
                <input id="loginPassword" type="password" placeholder="Senha" />
            </div>
            <div id="loginError" class="modal-feedback" aria-live="polite"></div>
            <div class="modal-actions">
                <button id="loginButton" class="btn">Entrar</button>
            </div>
        </div>
    </div>

    <div id="managementPasswordOverlay" class="overlay">
        <div class="modal">
            <h2>Acesso √† Administra√ß√£o</h2>
            <p>Por favor, insira a senha de acesso.</p>
            <div class="modal-row">
                <label for="managementPassword">Senha</label>
                <input id="managementPassword" type="password" />
            </div>
            <div id="managementPasswordError" class="modal-feedback" aria-live="polite"></div>
            <div class="modal-actions">
                <button id="managementPasswordCancel" class="btn btn-secondary">Cancelar</button>
                <button id="managementPasswordSubmit" class="btn">Entrar</button>
            </div>
        </div>
    </div>

    <div id="authEditorOverlay" class="overlay">
        <div class="modal modal-large">
            <h2>Editor de Autentica√ß√£o (auth.csv)</h2>
            <div class="modal-row">
                <label for="authEditorTextarea">Conte√∫do do arquivo:</label>
                <textarea id="authEditorTextarea"></textarea>
            </div>
            <div id="authEditorFeedback" class="modal-feedback" aria-live="polite"></div>
            <div class="modal-actions">
                <button id="authEditorExit" class="btn btn-secondary">Sair</button>
                <button id="authEditorSave" class="btn">Salvar</button>
            </div>
        </div>
    </div>

    <div id="databaseEditorOverlay" class="overlay">
        <div class="modal modal-large">
            <h2>Editor de Produtos (database.csv)</h2>
            <div class="modal-row">
                <label for="databaseEditorTextarea">Conte√∫do do arquivo:</label>
                <textarea id="databaseEditorTextarea"></textarea>
            </div>
            <div id="databaseEditorFeedback" class="modal-feedback" aria-live="polite"></div>
            <div class="modal-actions">
                <button id="databaseEditorExit" class="btn btn-secondary">Sair</button>
                <button id="databaseEditorSave" class="btn">Salvar</button>
            </div>
        </div>
    </div>

    <div id="logViewerOverlay" class="overlay">
        <div class="modal modal-large">
            <h2>Registro de Conex√µes (registro_acessos.csv)</h2>
            <div class="modal-row">
                <label for="logViewerTextarea">Conte√∫do do arquivo de log:</label>
                <textarea id="logViewerTextarea" readonly></textarea>
            </div>
            <div id="logViewerFeedback" class="modal-feedback" aria-live="polite"></div>
            <div class="modal-actions">
                <button id="logViewerExit" class="btn btn-secondary">Fechar</button>
            </div>
        </div>
    </div>

<script>
// Mantive a l√≥gica JS original praticamente intacta ‚Äî s√≥ formata√ß√£o m√≠nima para o arquivo.
document.addEventListener('DOMContentLoaded', function() {
    // --- Seletores de Elementos ---
    const tableBody = document.getElementById('productTableBody');
    const searchInput = document.getElementById('searchInput');
    const brandFiltersContainer = document.getElementById('brandFilters');
    const verticalFiltersContainer = document.getElementById('verticalFilters');
    const stockHeader = document.getElementById('stockHeader');
    const stockArrow = document.getElementById('stockArrow');

    // Login UI
    const loginOverlay = document.getElementById('loginOverlay');
    const loginButton = document.getElementById('loginButton');
    const loginEmail = document.getElementById('loginEmail');
    const loginPassword = document.getElementById('loginPassword');
    const loginError = document.getElementById('loginError');

    // Settings UI (Engrenagem)
    const settingsGear = document.getElementById('settings-gear');
    const settingsMenu = document.getElementById('settings-menu');
    const managementBtn = document.getElementById('management-btn');
    const editProductsBtn = document.getElementById('edit-products-btn');
    const connectionsBtn = document.getElementById('connections-btn');

    // Management Password UI
    const managementPasswordOverlay = document.getElementById('managementPasswordOverlay');
    const managementPasswordInput = document.getElementById('managementPassword');
    const managementPasswordSubmit = document.getElementById('managementPasswordSubmit');
    const managementPasswordCancel = document.getElementById('managementPasswordCancel');
    const managementPasswordError = document.getElementById('managementPasswordError');

    // Auth Editor UI
    const authEditorOverlay = document.getElementById('authEditorOverlay');
    const authEditorTextarea = document.getElementById('authEditorTextarea');
    const authEditorSave = document.getElementById('authEditorSave');
    const authEditorExit = document.getElementById('authEditorExit');
    const authEditorFeedback = document.getElementById('authEditorFeedback');

    // Database Editor UI
    const databaseEditorOverlay = document.getElementById('databaseEditorOverlay');
    const databaseEditorTextarea = document.getElementById('databaseEditorTextarea');
    const databaseEditorSave = document.getElementById('databaseEditorSave');
    const databaseEditorExit = document.getElementById('databaseEditorExit');
    const databaseEditorFeedback = document.getElementById('databaseEditorFeedback');

    // NOVO: Log Viewer UI
    const logViewerOverlay = document.getElementById('logViewerOverlay');
    const logViewerTextarea = document.getElementById('logViewerTextarea');
    const logViewerExit = document.getElementById('logViewerExit');
    const logViewerFeedback = document.getElementById('logViewerFeedback');

    // --- Estado da Aplica√ß√£o ---
    let allProducts = [];
    let activeBrand = 'all';
    let activeVertical = 'all';
    let stockSortOrder = null;
    let actionAfterPassword = null;

    // --- Fun√ß√µes da Tabela Principal ---
    function renderTable(products) {
        tableBody.innerHTML = '';
        if (products.length === 0) {
            const row = tableBody.insertRow();
            const cell = row.insertCell();
            cell.colSpan = 5;
            cell.textContent = 'Nenhum produto encontrado.';
            cell.style.textAlign = 'center';
            cell.style.padding = '20px';
        } else {
            products.forEach(product => {
                const row = tableBody.insertRow();
                row.insertCell().textContent = product.NOME || 'N/A';
                row.insertCell().textContent = product.Id || 'N/A';
                row.insertCell().textContent = product.MARCA || 'N/A';
                row.insertCell().textContent = product.VERTICAL || 'N/A';
                const stockCell = row.insertCell();
                const stock = parseInt(product.ESTOQUE, 10);
                stockCell.textContent = isNaN(stock) ? '0' : stock;
                if (stock < 5) {
                    stockCell.classList.add('stock-low');
                    stockCell.textContent = `‚ö†Ô∏è ${stock}`;
                }
                // --- Nova coluna Unid.Vend ---
                row.insertCell().textContent = product["Unid.Vend"] || 'N/A';

                // --- Nova coluna Obs (com tooltip/bot√£o) ---
                const obsCell = row.insertCell();
                if (product.Obs) {
                    const btn = document.createElement("button");
                    btn.textContent = "‚ÑπÔ∏è";
                    btn.classList.add("btn-obs");
                    btn.addEventListener("click", () => {
                        alert(product.Obs);
                    });
                    obsCell.appendChild(btn);
                } else {
                    obsCell.textContent = "-";
                }
            });
        }
    }

    function applyFiltersAndSort() {
        const searchTerm = searchInput.value.trim().toLowerCase();
        let filteredProducts;

        if (searchTerm) {
            // üîé Pesquisa ignora filtros de marca/vertical
            filteredProducts = allProducts.filter(p => {
                return (p.NOME || '').toLowerCase().includes(searchTerm) ||
                    (p.MARCA || '').toLowerCase().includes(searchTerm) ||
                    (p.VERTICAL || '').toLowerCase().includes(searchTerm) ||
                    String(p.Id || '').toLowerCase().includes(searchTerm); // agora pesquisa por ID
            });
        } else {
            // üîé Sem pesquisa ‚Üí aplica s√≥ filtros
            filteredProducts = allProducts.filter(p => {
                const brand = p.MARCA || '';
                const vertical = p.VERTICAL || '';
                const matchesBrand = activeBrand === 'all' || brand === activeBrand;
                const matchesVertical = activeVertical === 'all' || vertical === activeVertical;
                return matchesBrand && matchesVertical;
            });
        }

        // Ordena√ß√£o de estoque
        if (stockSortOrder === 'asc') {
            filteredProducts.sort((a, b) => (parseInt(a.ESTOQUE, 10) || 0) - (parseInt(b.ESTOQUE, 10) || 0));
        } else if (stockSortOrder === 'desc') {
            filteredProducts.sort((a, b) => (parseInt(b.ESTOQUE, 10) || 0) - (parseInt(a.ESTOQUE, 10) || 0));
        }

        renderTable(filteredProducts);
    }


    function createFilterButtons(container, items, filterType) {
        container.innerHTML = '<button class="active" data-filter="all">Todas</button>';
        items.forEach(item => {
            if (item) {
                const button = document.createElement('button');
                button.textContent = item;
                button.dataset.filter = item;
                container.appendChild(button);
            }
        });
        container.addEventListener('click', function(e) {
            if (e.target.tagName === 'BUTTON') {
                const filterValue = e.target.dataset.filter;
                if (filterType === 'brand') activeBrand = filterValue;
                else if (filterType === 'vertical') activeVertical = filterValue;
                container.querySelector('.active').classList.remove('active');
                e.target.classList.add('active');
                applyFiltersAndSort();
            }
        });
    }

    async function initializeApp() {
        try {
            const response = await fetch('/api/products');
            if (!response.ok) throw new Error(`Erro na rede: ${response.statusText}`);
            
            // ‚õîÔ∏è aqui filtramos os NaN
            allProducts = (await response.json()).filter(p => {
                return p.Id && String(p.Id).toLowerCase() !== "nan";
            });

            const uniqueBrands = [...new Set(allProducts.map(p => p.MARCA))].sort();
            const uniqueVerticals = [...new Set(allProducts.map(p => p.VERTICAL))].sort();
            createFilterButtons(brandFiltersContainer, uniqueBrands, 'brand');
            createFilterButtons(verticalFiltersContainer, uniqueVerticals, 'vertical');
            searchInput.addEventListener('input', applyFiltersAndSort);
            stockHeader.addEventListener('click', () => {
                if (stockSortOrder === 'asc') { stockSortOrder = 'desc'; stockArrow.textContent = '‚Üì'; }
                else if (stockSortOrder === 'desc') { stockSortOrder = null; stockArrow.textContent = '‚Üï'; }
                else { stockSortOrder = 'asc'; stockArrow.textContent = '‚Üë'; }
                applyFiltersAndSort();
            });
            applyFiltersAndSort();
        } catch (error) {
            console.error('Falha ao carregar os dados dos produtos:', error);
            tableBody.innerHTML = `<tr><td colspan="5" style="text-align:center; color:#ffb3a7;">Erro ao carregar os dados.</td></tr>`;
        }
    }

    async function attemptLogin() {
        loginError.textContent = '';
        const email = loginEmail.value.trim();
        const password = loginPassword.value;
        if (!email || !password) { 
            loginError.textContent = 'Preencha e-mail e senha.'; 
            return; 
        }

        loginButton.disabled = true; 
        loginButton.textContent = 'Entrando...';

        try {
            const res = await fetch('/api/login', { 
                method: 'POST', 
                headers: { 'Content-Type': 'application/json' }, 
                body: JSON.stringify({ email, password }) 
            });
            
            // tenta converter resposta em JSON
            let data = {};
            try {
                data = await res.json();
            } catch {
                throw new Error("Resposta inv√°lida do servidor.");
            }

            if (res.ok && data.success) {
                loginOverlay.classList.remove('visible');

                // üîπ Atualiza tabela de produtos
                await initializeApp();

                // üîπ Verifica sincroniza√ß√£o
                if (data.sync_success === false) {
                    alert("‚ö†Ô∏è Aviso: O estoque N√ÉO foi sincronizado.\nVerifique sua conex√£o com a API.");
                } else {
                    console.log("‚úÖ Estoque sincronizado com sucesso.");
                }

            } else {
                loginError.textContent = data.message || 'Credenciais inv√°lidas.';
            }
        } catch (err) {
            console.error('Erro no login:', err);
            loginError.textContent = 'Erro de rede ao tentar autenticar.';
            alert("‚ùå Erro: N√£o foi poss√≠vel autenticar ou sincronizar o estoque.\nDetalhes: " + err.message);
        } finally {
            loginButton.disabled = false; 
            loginButton.textContent = 'Entrar';
        }
    }



    settingsGear.addEventListener('click', () => { settingsMenu.classList.toggle('visible'); });
    document.addEventListener('click', (e) => { if (!settingsGear.contains(e.target) && !settingsMenu.contains(e.target)) settingsMenu.classList.remove('visible'); });

    managementBtn.addEventListener('click', () => { actionAfterPassword = 'openAuthEditor'; settingsMenu.classList.remove('visible'); managementPasswordOverlay.classList.add('visible'); managementPasswordInput.focus(); });
    editProductsBtn.addEventListener('click', () => { actionAfterPassword = 'openDatabaseEditor'; settingsMenu.classList.remove('visible'); managementPasswordOverlay.classList.add('visible'); managementPasswordInput.focus(); });
    connectionsBtn.addEventListener('click', () => { actionAfterPassword = 'openLogViewer'; settingsMenu.classList.remove('visible'); managementPasswordOverlay.classList.add('visible'); managementPasswordInput.focus(); });

    managementPasswordCancel.addEventListener('click', () => { managementPasswordOverlay.classList.remove('visible'); managementPasswordInput.value = ''; managementPasswordError.textContent = ''; actionAfterPassword = null; });

    managementPasswordSubmit.addEventListener('click', () => {
        const password = managementPasswordInput.value;
        if (password === "SenhaForte10@") {
            managementPasswordOverlay.classList.remove('visible'); managementPasswordInput.value = ''; managementPasswordError.textContent = '';
            if (actionAfterPassword === 'openAuthEditor') openAuthEditor();
            else if (actionAfterPassword === 'openDatabaseEditor') openDatabaseEditor();
            else if (actionAfterPassword === 'openLogViewer') openLogViewer();
            actionAfterPassword = null;
        } else { managementPasswordError.textContent = "Senha incorreta. Tente novamente."; managementPasswordInput.value = ''; }
    });

    async function openAuthEditor() {
        authEditorOverlay.classList.add('visible'); authEditorTextarea.value = 'Carregando dados...'; authEditorFeedback.textContent = '';
        try { const response = await fetch('/get-auth-file'); if (!response.ok) throw new Error('Falha ao buscar dados.'); const data = await response.text(); authEditorTextarea.value = data; }
        catch (error) { authEditorTextarea.value = `Erro ao carregar o arquivo auth.csv:\n\n${error.message}`; authEditorFeedback.textContent = 'N√£o foi poss√≠vel carregar os dados.'; }
    }
    authEditorExit.addEventListener('click', () => { authEditorOverlay.classList.remove('visible'); });
    authEditorSave.addEventListener('click', async () => { const newContent = authEditorTextarea.value; authEditorSave.disabled = true; authEditorSave.textContent = 'Salvando...'; authEditorFeedback.textContent = '';
        try { const response = await fetch('/save-auth-file', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ content: newContent }) }); if (!response.ok) throw new Error('O servidor retornou um erro.'); const result = await response.json(); if (result.status === 'ok') { authEditorFeedback.classList.add('success'); authEditorFeedback.textContent = 'Salvo com sucesso!'; } else { throw new Error('O servidor n√£o confirmou o salvamento.'); } }
        catch (error) { authEditorFeedback.classList.remove('success'); authEditorFeedback.textContent = `Erro ao salvar: ${error.message}`; }
        finally { authEditorSave.disabled = false; authEditorSave.textContent = 'Salvar'; setTimeout(() => { authEditorFeedback.textContent = ''; }, 3000); }
    });

    async function openDatabaseEditor() {
        databaseEditorOverlay.classList.add('visible'); databaseEditorTextarea.value = 'Carregando dados dos produtos...'; databaseEditorFeedback.textContent = '';
        try { const response = await fetch('/get-database-file'); if (!response.ok) throw new Error('Falha ao buscar dados.'); const data = await response.text(); databaseEditorTextarea.value = data; }
        catch (error) { databaseEditorTextarea.value = `Erro ao carregar o arquivo database.csv:\n\n${error.message}`; databaseEditorFeedback.textContent = 'N√£o foi poss√≠vel carregar os dados.'; }
    }
    databaseEditorExit.addEventListener('click', () => { databaseEditorOverlay.classList.remove('visible'); });
    databaseEditorSave.addEventListener('click', async () => { const newContent = databaseEditorTextarea.value; databaseEditorSave.disabled = true; databaseEditorSave.textContent = 'Salvando...'; databaseEditorFeedback.textContent = '';
        try { const response = await fetch('/save-database-file', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ content: newContent }) }); if (!response.ok) throw new Error('O servidor retornou um erro.'); const result = await response.json(); if (result.status === 'ok') { databaseEditorFeedback.classList.add('success'); databaseEditorFeedback.textContent = 'Salvo com sucesso! As altera√ß√µes podem exigir uma atualiza√ß√£o da p√°gina.'; } else { throw new Error('O servidor n√£o confirmou o salvamento.'); } }
        catch (error) { databaseEditorFeedback.classList.remove('success'); databaseEditorFeedback.textContent = `Erro ao salvar: ${error.message}`; }
        finally { databaseEditorSave.disabled = false; databaseEditorSave.textContent = 'Salvar'; setTimeout(() => { databaseEditorFeedback.textContent = ''; }, 4000); }
    });

    async function openLogViewer() {
        logViewerOverlay.classList.add('visible'); logViewerTextarea.value = 'Carregando registro de conex√µes...'; logViewerFeedback.textContent = '';
        try { const response = await fetch('/get-access-log-file'); if (!response.ok) { const errorText = await response.text(); throw new Error(`Falha ao buscar dados: ${errorText}`); } const data = await response.text(); logViewerTextarea.value = data || "O arquivo de log est√° vazio."; }
        catch (error) { logViewerTextarea.value = `Erro ao carregar o arquivo de log:\n\n${error.message}`; logViewerFeedback.textContent = 'N√£o foi poss√≠vel carregar os dados.'; }
    }
    logViewerExit.addEventListener('click', () => { logViewerOverlay.classList.remove('visible'); });

    // Inicializa√ß√£o e atalhos
    loginButton.addEventListener('click', attemptLogin);
    [loginEmail, loginPassword].forEach(el => { el.addEventListener('keydown', (ev) => { if (ev.key === 'Enter') attemptLogin(); }); });
    managementPasswordInput.addEventListener('keydown', (ev) => { if (ev.key === 'Enter') managementPasswordSubmit.click(); });
});
</script>
</body>
</html>
